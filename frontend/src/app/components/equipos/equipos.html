<div class="container py-4">

  <!-- Botonera como píldoras de acción -->
  <div class="d-flex justify-content-center gap-3 mb-4 flex-wrap">
    <button class="action-pill"
            (click)="seleccionarAccion('listar')"
            [class.active]="selectedAction==='listar'"
            aria-label="Listar">
      <i class="bi bi-card-list"></i>
      Listar
    </button>

    <button class="action-pill success"
            (click)="seleccionarAccion('crear')"
            [class.active]="selectedAction==='crear'"
            aria-label="Crear">
      <i class="bi bi-clipboard-plus"></i>
      Crear
    </button>
  </div>

  <!-- =============== LISTAR =============== -->
  <div *ngIf="selectedAction==='listar'">
    <h4 class="text-center mb-3">Equipos</h4>

    <!-- Skeleton primera carga -->
    <div *ngIf="loading && equipos.length === 0" class="list-group">
      <div class="list-group-item" *ngFor="let s of [1,2,3,4,5]">
        <div class="placeholder-glow">
          <span class="placeholder col-4 me-2"></span>
          <span class="placeholder col-3 me-2"></span>
          <span class="placeholder col-2"></span>
        </div>
        <div class="placeholder-glow mt-2">
          <span class="placeholder col-8"></span>
        </div>
      </div>
    </div>

    <!-- Estado vacío (sin equipos) -->
    <ng-container *ngIf="!loading && equipos.length === 0; else listContent">
      <div class="empty-state">
        <div class="icon-wrap">
          <i class="bi bi-laptop"></i>
        </div>
        <h5 class="mb-1">Aún no cargaste equipos</h5>
        <p class="text-muted mb-3">
          Registrá tu primer equipo para verlo acá.
        </p>
        <div class="d-flex justify-content-center gap-2">
          <button class="action-pill success" (click)="seleccionarAccion('crear')">
            <i class="bi bi-clipboard-plus me-1"></i> Crear equipo
          </button>
          <button class="action-pill" (click)="resetLista()">
            <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
          </button>
        </div>
      </div>
    </ng-container>

    <!-- Contenido listado -->
    <ng-template #listContent>

      <!-- Sin resultados por búsqueda -->
      <div *ngIf="searchTerm && equipos.length === 0 && !loading" class="empty-state">
        <div class="icon-wrap">
          <i class="bi bi-search"></i>
        </div>
        <h5 class="mb-1">No se encontraron resultados</h5>
        <p class="text-muted mb-3">
          No hay equipos que coincidan con "{{ searchTerm }}"
        </p>
        <div class="d-flex justify-content-center gap-2">
          <button class="action-pill" (click)="searchService.clearSearch()">
            <i class="bi bi-x-circle me-1"></i> Limpiar búsqueda
          </button>
          <button class="action-pill success" (click)="seleccionarAccion('crear')">
            <i class="bi bi-clipboard-plus me-1"></i> Crear nuevo equipo
          </button>
        </div>
      </div>

      <!-- Lista de equipos -->
      <div class="list-group" *ngIf="equipos.length > 0">
        <div *ngFor="let e of equipos" class="list-group-item">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">

            <!-- Izquierda: datos / edición -->
            <div class="flex-grow-1">
              <!-- Vista normal -->
              <ng-container *ngIf="editingId !== e.id; else editRow">
                <div class="fw-semibold mb-1">
                  Equipo #{{ e.id }}
                </div>
                <div class="text-muted small">
                  <div class="mb-1">
                    <strong>Descripción:</strong>
                    {{ e.descripcion || 'Sin descripción' }}
                  </div>
                  <div>
                    <strong>Cliente:</strong>
                    {{ getClienteNombre(e.cliente_id) }}
                    <ng-container *ngIf="getClienteTelefono(e.cliente_id)">
                      · <strong>Tel:</strong> {{ getClienteTelefono(e.cliente_id) }}
                    </ng-container>
                  </div>
                </div>
              </ng-container>

              <!-- Fila de edición -->
              <ng-template #editRow>
                <div class="row g-2">
                  <div class="col-12 col-md-8">
                    <label class="form-label small">Descripción</label>
                    <input type="text"
                           class="form-control"
                           [(ngModel)]="editBuffer.descripcion"
                           name="descripcionEdit" />
                  </div>

                  <div class="col-12 col-md-4">
                    <label class="form-label small">Cliente</label>
                    <select class="form-select"
                            [(ngModel)]="editBuffer.cliente_id"
                            name="clienteEdit">
                      <option [ngValue]="null">Seleccionar cliente...</option>
                      <option *ngFor="let c of clientes" [ngValue]="c.id">
                        {{ c.nombre }}
                        <ng-container *ngIf="c.telefono">
                          — {{ c.telefono }}
                        </ng-container>
                      </option>
                    </select>
                  </div>
                </div>
              </ng-template>
            </div>

            <!-- Derecha: acciones -->
            <div class="d-flex gap-2">
              <!-- Botón editar -->
              <button *ngIf="editingId !== e.id"
                      class="btn btn-sm btn-outline-warning btn-action"
                      (click)="startEdit(e)"
                      title="Editar">
                <i class="bi bi-pencil-square"></i>
              </button>

              <!-- Guardar / cancelar edición -->
              <ng-container *ngIf="editingId === e.id">
                <button class="btn btn-sm btn-success btn-action"
                        (click)="saveEdit(e.id)"
                        title="Guardar">
                  <i class="bi bi-check-lg"></i>
                </button>
                <button class="btn btn-sm btn-secondary btn-action"
                        (click)="cancelEdit()"
                        title="Cancelar">
                  <i class="bi bi-x-lg"></i>
                </button>
              </ng-container>

              <!-- Eliminar -->
              <button class="btn btn-sm btn-outline-danger btn-action"
                      (click)="eliminar(e.id)"
                      title="Eliminar">
                <i class="bi bi-trash"></i>
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Loader incremental -->
      <div class="text-center mt-3" *ngIf="loading && equipos.length > 0">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2 text-muted small">Cargando más equipos...</div>
      </div>

      <!-- CTA si hay pocos ítems -->
      <div *ngIf="!loading && equipos.length && equipos.length < 3 && !searchTerm"
           class="text-center mt-3">
        <button class="action-pill success" (click)="seleccionarAccion('crear')">
          <i class="bi bi-clipboard-plus me-1"></i> Registrar nuevo equipo
        </button>
      </div>
    </ng-template>
  </div>

  <!-- =============== CREAR =============== -->
  <div *ngIf="selectedAction==='crear'">
    <h4 class="text-center mb-3">Registrar Equipo</h4>

    <form (ngSubmit)="crear()" class="form-max-width">
      <div class="row g-3">

        <!-- Descripción -->
        <div class="col-12">
          <label class="form-label">Descripción <span class="text-danger">*</span></label>
          <input type="text"
                 class="form-control"
                 [(ngModel)]="nuevo.descripcion"
                 name="descripcion"
                 required
                 placeholder="Ej.: Notebook Dell Latitude, i5, 8GB RAM..." />
        </div>

        <!-- Cliente -->
        <div class="col-12">
          <label class="form-label">Cliente <span class="text-danger">*</span></label>
          <select class="form-select"
                  [(ngModel)]="nuevo.cliente_id"
                  name="cliente_id"
                  required>
            <option [ngValue]="null">Seleccionar cliente...</option>
            <option *ngFor="let c of clientes" [ngValue]="c.id">
              {{ c.nombre }}
              <ng-container *ngIf="c.telefono">
                — {{ c.telefono }}
              </ng-container>
            </option>
          </select>
          <div class="form-text">
            Podés escribir mientras el menú está abierto para buscar por nombre.
          </div>
        </div>

      </div>

      <!-- Botones acción -->
      <div class="d-flex gap-2 mt-4">
        <button class="action-pill success flex-fill" type="submit">
          <i class="bi bi-check2-circle me-1"></i> Guardar Equipo
        </button>
        <button type="button" class="action-pill"
                (click)="seleccionarAccion('listar')">
          <i class="bi bi-arrow-left me-1"></i> Volver
        </button>
      </div>
    </form>
  </div>
</div>
