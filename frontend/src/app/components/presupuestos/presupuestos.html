<div class="container py-4">

  <!-- Botonera como píldoras de acción -->
  <div class="d-flex justify-content-center gap-3 mb-4 flex-wrap">
    <button class="action-pill"
            (click)="seleccionarAccion('listar')"
            [class.active]="selectedAction==='listar'"
            aria-label="Listar">
      <i class="bi bi-card-list"></i>
      Listar
    </button>

    <button class="action-pill success"
            (click)="seleccionarAccion('crear')"
            [class.active]="selectedAction==='crear'"
            [disabled]="!canCreate()"
            aria-label="Crear">
      <i class="bi bi-clipboard-plus"></i>
      Crear
      <span *ngIf="!canCreate()" class="badge bg-secondary ms-1" title="Sin permisos">
        <i class="bi bi-lock"></i>
      </span>
    </button>
  </div>

  <!-- LISTAR -->
  <div *ngIf="selectedAction==='listar'">
    <h4 class="text-center mb-3">Presupuestos</h4>

    <!-- Pantalla de carga durante búsqueda -->
    <div *ngIf="buscandoPresupuestos && items.length === 0" class="search-loading">
      <div class="text-center py-5">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Buscando...</span>
        </div>
        <h5 class="text-muted">Buscando presupuestos...</h5>
        <p class="text-muted small">Buscando "{{ searchTerm }}"</p>
      </div>
    </div>

    <!-- Skeleton primera carga -->
    <div *ngIf="loading && items.length === 0 && !buscandoPresupuestos" class="list-group">
      <div class="list-group-item" *ngFor="let s of [1,2,3,4,5]">
        <div class="placeholder-glow">
          <span class="placeholder col-4 me-2"></span>
          <span class="placeholder col-2 me-2"></span>
          <span class="placeholder col-3"></span>
        </div>
        <div class="placeholder-glow mt-2">
          <span class="placeholder col-8"></span>
        </div>
      </div>
    </div>

    <!-- Estado vacío -->
    <ng-container *ngIf="!loading && items.length === 0 && !buscandoPresupuestos; else listContent">
      <div class="empty-state">
        <div class="icon-wrap">
          <i class="bi bi-clipboard-check"></i>
        </div>
        <h5 class="mb-1">Aún no cargaste presupuestos</h5>
        <p class="text-muted mb-3" *ngIf="!searchTerm">
          Registrá tu primer presupuesto para verlo acá.
        </p>
        <div class="d-flex justify-content-center gap-2">
          <button class="action-pill success" (click)="seleccionarAccion('crear')">
            <i class="bi bi-clipboard-plus me-1"></i> Crear presupuesto
          </button>
          <button class="action-pill" (click)="resetLista()">
            <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
          </button>
        </div>
      </div>
    </ng-container>

    <!-- Contenido listado -->
    <ng-template #listContent>
      <div *ngIf="searchTerm && items.length === 0 && !loading && !buscandoPresupuestos" class="empty-state">
        <div class="icon-wrap">
          <i class="bi bi-search"></i>
        </div>
        <h5 class="mb-1">No se encontraron resultados</h5>
        <p class="text-muted mb-3">
          No hay presupuestos que coincidan con "{{ searchTerm }}"
        </p>
        <div class="d-flex justify-content-center gap-2">
          <button class="action-pill" (click)="resetLista()">
            <i class="bi bi-x-circle me-1"></i> Limpiar búsqueda
          </button>
          <button class="action-pill success" (click)="seleccionarAccion('crear')">
            <i class="bi bi-clipboard-plus me-1"></i> Crear nuevo
          </button>
        </div>
      </div>

      <div class="list-group" *ngIf="items.length > 0">
        <div *ngFor="let p of items" class="list-group-item">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">

            <!-- Izquierda: datos -->
            <div class="flex-grow-1">
              <ng-container *ngIf="editingId !== p.id; else editRow">
                <!-- REEMPLAZA la sección de datos del presupuesto con esto -->
<div class="fw-semibold mb-2 presupuesto-titulo">
  <span *ngIf="cargandoDescripciones.has(p.reparacion_id)" class="loading-dots">
    <span class="loading-dots-text">Cargando información</span>
    <span class="loading-dots-container">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </span>
  </span>
  
  <span *ngIf="!cargandoDescripciones.has(p.reparacion_id)">
    {{ getTituloPresupuesto(p) }}
    <span class="badge ms-2 estado-badge" [class.bg-success]="p.aceptado" [class.bg-secondary]="!p.aceptado">
      {{ p.aceptado ? 'Aceptado' : 'Pendiente' }}
    </span>
  </span>
</div>

<div class="presupuesto-info">
  <!-- Línea principal de la reparación -->
  <div class="info-line principal">
    <i class="bi bi-tools icono-destacado"></i>
    <span class="info-label">Reparación:</span>
    <span class="info-value destacado">{{ getDescripcionReparacion(p.reparacion_id) }}</span>
  </div>

  <!-- Información del equipo y cliente -->
  <div class="info-line" *ngIf="getInfoEquipo(p.reparacion_id) || getInfoCliente(p.reparacion_id)">
    <i class="bi bi-pc-display"></i>
    <span class="info-label">Equipo:</span>
    <span class="info-value">{{ getInfoEquipo(p.reparacion_id) }}</span>
    <span class="info-separator">|</span>
    <i class="bi bi-person"></i>
    <span class="info-label">Cliente:</span>
    <span class="info-value">{{ getInfoCliente(p.reparacion_id) }}</span>
  </div>

  <!-- Información del técnico -->
  <div class="info-line" *ngIf="getInfoTecnico(p.reparacion_id)">
    <i class="bi bi-person-gear"></i>
    <span class="info-label">Técnico:</span>
    <span class="info-value">{{ getInfoTecnico(p.reparacion_id) }}</span>
  </div>

  <!-- Fecha y monto -->
  <div class="info-line datos-financieros">
    <i class="bi bi-calendar"></i>
    <span class="info-label">Fecha:</span>
    <span class="info-value">{{ p.fecha | date:'dd/MM/yyyy' }}</span>
    <span class="info-separator">|</span>
    <i class="bi bi-currency-dollar"></i>
    <span class="info-label">Monto:</span>
    <span class="info-value monto-destacado">{{ (p.monto_total ?? 0) | number:'1.2-2' }}</span>
  </div>
</div>
              </ng-container>

              <!-- EDICIÓN -->
              <ng-template #editRow>
                <div class="row g-2">
                  <div class="col-12">
                    <label class="form-label small">Reparación</label>
                    <div class="search-container">
                      <input type="text" 
                             class="form-control search-input" 
                             [(ngModel)]="editBuffer.reparacionBusqueda"
                             (input)="onBuscarReparacionEdit(editBuffer.reparacionBusqueda)"
                             (focus)="mostrandoReparacionesEdit = true"
                             (blur)="ocultarReparacionesEdit()"
                             placeholder="Buscar reparación..."
                             name="reparacionBusquedaEdit"
                             autocomplete="off" />
                      
                      <!-- Limpiar selección -->
                      <button *ngIf="editBuffer.reparacionBusqueda" 
                              type="button" 
                              class="btn-clear"
                              (click)="limpiarReparacionEdit()" 
                              title="Limpiar búsqueda">
                        <i class="bi bi-x"></i>
                      </button>

                      <!-- Dropdown de sugerencias -->
                      <div *ngIf="mostrandoReparacionesEdit && reparacionesSugeridasEdit.length > 0" 
                           class="sugerencias-menu">
                        <div class="sugerencias-header">
                          <i class="bi bi-search"></i>
                          Reparaciones encontradas
                          <span class="sugerencias-count">{{ reparacionesSugeridasEdit.length }}</span>
                        </div>
                        <div *ngFor="let reparacion of reparacionesSugeridasEdit" 
                             class="sugerencia-item"
                             (mousedown)="seleccionarReparacionEdit(reparacion)">
                          <div class="sugerencia-content">
                            <strong>{{ reparacion.descripcion }}</strong>
                            <div class="sugerencia-details">
                              Equipo: {{ reparacion.equipo?.descripcion }} | 
                              Técnico: {{ reparacion.tecnico?.nombre }} | 
                              Estado: {{ reparacion.estado }}
                            </div>
                            <div class="sugerencia-details">
                              Fecha: {{ reparacion.fecha | date:'dd/MM/yyyy' }} | ID: {{ reparacion.id }}
                            </div>
                          </div>
                          <i class="bi bi-chevron-right"></i>
                        </div>
                      </div>

                      <!-- Sin resultados -->
                      <div *ngIf="mostrandoReparacionesEdit && !buscandoReparacionesEdit && reparacionesSugeridasEdit.length === 0 && editBuffer.reparacionBusqueda" 
                           class="sugerencias-menu">
                        <div class="sugerencias-header">
                          <i class="bi bi-search"></i>
                          Sin resultados
                        </div>
                        <div class="sugerencia-item text-muted">
                          <div class="sugerencia-content text-center py-3">
                            <i class="bi bi-exclamation-circle d-block mb-2" style="font-size: 1.5rem;"></i>
                            No se encontraron reparaciones para "{{ editBuffer.reparacionBusqueda }}"
                          </div>
                        </div>
                      </div>

                      <!-- Estado de carga -->
                      <div *ngIf="buscandoReparacionesEdit" class="position-absolute end-0 top-50 translate-middle-y me-2">
                        <div class="spinner-border spinner-border-sm text-primary loading-small" role="status"></div>
                      </div>
                    </div>
                    
                  </div>

                  <div class="col-6 col-md-3">
                    <label class="form-label small">Fecha</label>
                    <input 
                      type="date" 
                      class="form-control" 
                      [(ngModel)]="editBuffer.fecha" 
                      [min]="getToday()"
                    />
                  </div>
                  <div class="col-6 col-md-3">
                    <label class="form-label small">Monto total</label>
                    <input type="number" step="0.01" class="form-control" [(ngModel)]="editBuffer.monto_total" />
                  </div>
                  <div class="col-12 col-md-3 d-flex align-items-end">
                    <div class="form-check">
                      <input id="chkAceptado{{p.id}}" class="form-check-input" type="checkbox"
                            [(ngModel)]="editBuffer.aceptado" [ngModelOptions]="{standalone:true}">
                      <label class="form-check-label small" [for]="'chkAceptado'+p.id">Aceptado</label>
                    </div>
                  </div>
                </div>
              </ng-template>
            </div>

            <!-- Derecha: acciones -->
            <div class="d-flex gap-2">
              <button *ngIf="editingId !== p.id && canEdit()" 
                      class="btn btn-sm btn-outline-warning btn-action" 
                      (click)="startEdit(p)" 
                      title="Editar">
                <i class="bi bi-pencil-square"></i>
              </button>

              <ng-container *ngIf="editingId === p.id">
                <button class="btn btn-sm btn-success btn-action" (click)="saveEdit(p.id)" title="Guardar">
                  <i class="bi bi-check-lg"></i>
                </button>
                <button class="btn btn-sm btn-secondary btn-action" (click)="cancelEdit()" title="Cancelar">
                  <i class="bi bi-x-lg"></i>
                </button>
              </ng-container>

              <button *ngIf="canDelete()"
                      class="btn btn-sm btn-outline-danger btn-action" 
                      (click)="eliminar(p.id)" 
                      title="Eliminar">
                <i class="bi bi-trash"></i>
              </button>

                <span *ngIf="isUser() && !canEdit() && !canDelete()" 
                      class="text-muted small align-self-center">
                  <i class="bi bi-eye"></i> Solo lectura
                </span>
            </div>

          </div>
        </div>
      </div>

      <!-- Loader incremental -->
      <div class="text-center mt-3" *ngIf="loading && items.length > 0">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2 text-muted small">
          {{ isServerSearch && searchTerm ? 'Cargando más resultados...' : 'Cargando más presupuestos...' }}
        </div>
      </div>

      <!-- CTA si hay pocos ítems -->
      <div *ngIf="!loading && items.length && items.length < 3 && !searchTerm && !buscandoPresupuestos" class="text-center mt-3">
        <button class="action-pill success" (click)="seleccionarAccion('crear')">
          <i class="bi bi-clipboard-plus me-1"></i> Registrar nuevo presupuesto
        </button>
      </div>
    </ng-template>
  </div>

  <!-- Crear -->
  <div *ngIf="selectedAction==='crear'">
    <h4 class="text-center mb-3">Registrar Presupuesto</h4>

    <form (ngSubmit)="crear()" class="form-max-width">
      <div class="row g-3">
        
        <!-- BÚSQUEDA INTELIGENTE DE REPARACIÓN -->
        <div class="col-12">
          <label class="form-label">Reparación <span class="text-danger">*</span></label>
          <div class="search-container">
            <input type="text" 
                   class="form-control search-input" 
                   [(ngModel)]="nuevo.reparacionBusqueda" 
                   (input)="onBuscarReparacion(nuevo.reparacionBusqueda)"
                   (focus)="mostrandoReparaciones = true"
                   (blur)="ocultarReparaciones()"
                   placeholder="Buscar reparación por descripción, equipo o técnico..."
                   name="reparacionBusqueda"
                   required
                   autocomplete="off" />
            
            <!-- Limpiar selección -->
            <button *ngIf="nuevo.reparacionBusqueda" 
                    type="button" 
                    class="btn-clear"
                    (click)="limpiarReparacion()" 
                    title="Limpiar búsqueda">
              <i class="bi bi-x"></i>
            </button>

            <!-- Dropdown de sugerencias -->
            <div *ngIf="mostrandoReparaciones && reparacionesSugeridas.length > 0" 
                class="sugerencias-menu">
              <div class="sugerencias-header">
                <i class="bi bi-search"></i>
                Reparaciones encontradas
                <span class="sugerencias-count">{{ reparacionesSugeridas.length }}</span>
              </div>
              <div *ngFor="let reparacion of reparacionesSugeridas" 
                  class="sugerencia-item"
                  (mousedown)="seleccionarReparacion(reparacion)">
                <div class="sugerencia-content">
                  <!-- Línea principal en negrita -->
                  <div class="sugerencia-titulo">
                    <strong>{{ reparacion.descripcion }}</strong>
                    <span class="sugerencia-id">#{{ reparacion.id }}</span>
                  </div>
                  
                  <!-- Información secundaria -->
                  <div class="sugerencia-details">
                    <span class="sugerencia-info-item">
                      <i class="bi bi-pc-display"></i>
                      {{ reparacion.equipo?.descripcion || reparacion.equipo_nombre || 'Equipo no especificado' }}
                    </span>
                    <span class="sugerencia-info-item">
                      <i class="bi bi-person"></i>
                      {{ reparacion.equipo?.cliente?.nombre || reparacion.cliente_nombre || 'Cliente no especificado' }}
                    </span>
                  </div>
                  
                  <!-- Información adicional -->
                  <div class="sugerencia-details">
                    <span class="sugerencia-info-item">
                      <i class="bi bi-person-gear"></i>
                      {{ reparacion.tecnico?.nombre || reparacion.tecnico_nombre || 'Técnico no asignado' }}
                    </span>
                    <span class="sugerencia-info-item">
                      <i class="bi bi-calendar"></i>
                      {{ reparacion.fecha | date:'dd/MM/yyyy' }}
                    </span>
                    <span class="sugerencia-info-item">
                      <i class="bi bi-tag"></i>
                      <span [class]="'badge ' + getEstadoBadgeClass(reparacion.estado)">
                        {{ reparacion.estado }}
                      </span>
                    </span>
                  </div>
                </div>
                <i class="bi bi-chevron-right"></i>
              </div>
            </div>

            <!-- Sin resultados -->
            <div *ngIf="mostrandoReparaciones && !buscandoReparaciones && reparacionesSugeridas.length === 0 && nuevo.reparacionBusqueda" 
                 class="sugerencias-menu">
              <div class="sugerencias-header">
                <i class="bi bi-search"></i>
                Sin resultados
              </div>
              <div class="sugerencia-item text-muted">
                <div class="sugerencia-content text-center py-3">
                  <i class="bi bi-exclamation-circle d-block mb-2" style="font-size: 1.5rem;"></i>
                  No se encontraron reparaciones para "{{ nuevo.reparacionBusqueda }}"
                </div>
              </div>
            </div>

            <!-- Estado de carga -->
            <div *ngIf="buscandoReparaciones" class="position-absolute end-0 top-50 translate-middle-y me-2">
              <div class="spinner-border spinner-border-sm text-primary loading-small" role="status"></div>
            </div>
          </div>
          
          <!-- Badge de selección -->
          <div *ngIf="nuevo.reparacionSeleccionada" class="selection-badge">
            <i class="bi bi-check-circle"></i>
            Reparación seleccionada: {{ nuevo.reparacionSeleccionada.descripcion }}
            <small class="ms-2">(ID: {{ nuevo.reparacionSeleccionada.id }})</small>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Fecha <span class="text-danger">*</span></label>
          <input 
            type="date" 
            class="form-control" 
            [(ngModel)]="nuevo.fecha" 
            name="fecha" 
            required 
            [min]="getToday()"
          />
        </div>
        
        <div class="col-12 col-md-4">
          <label class="form-label">Monto total <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input type="number" min="0" step="0.01" class="form-control" 
                   [(ngModel)]="nuevo.monto_total" name="monto_total" 
                   placeholder="0.00" required />
          </div>
        </div>
        
        <div class="col-12 col-md-4 d-flex align-items-end">
          <div class="form-check form-switch">
            <input id="chkAceptadoNuevo" class="form-check-input" type="checkbox" 
                   [(ngModel)]="nuevo.aceptado" name="aceptado"
                   style="transform: scale(1.2);">
            <label for="chkAceptadoNuevo" class="form-check-label fw-semibold">
              Presupuesto Aceptado
            </label>
          </div>
        </div>

        <!-- Información de la reparación seleccionada -->
        <div *ngIf="nuevo.reparacionSeleccionada" class="col-12">
          <div class="card border-0 bg-light">
            <div class="card-body p-3">
              <h6 class="card-title mb-2">
                <i class="bi bi-info-circle me-2 text-primary"></i>
                Información de la Reparación Seleccionada
              </h6>
              <div class="row small text-muted">
                <div class="col-md-6">
                  <strong>Descripción:</strong> {{ nuevo.reparacionSeleccionada.descripcion }}
                </div>
                <div class="col-md-3">
                  <strong>Equipo:</strong> {{ nuevo.reparacionSeleccionada.equipo?.descripcion || 'No especificado' }}
                </div>
                <div class="col-md-3">
                  <strong>Técnico:</strong> {{ nuevo.reparacionSeleccionada.tecnico?.nombre || 'No asignado' }}
                </div>
                <div class="col-md-4">
                  <strong>Estado:</strong> 
                  <span [class]="'badge ' + getEstadoBadgeClass(nuevo.reparacionSeleccionada.estado)">
                    {{ nuevo.reparacionSeleccionada.estado }}
                  </span>
                </div>
                <div class="col-md-4">
                  <strong>Fecha reparación:</strong> {{ nuevo.reparacionSeleccionada.fecha | date:'dd/MM/yyyy' }}
                </div>
                <div class="col-md-4">
                  <strong>ID:</strong> {{ nuevo.reparacionSeleccionada.id }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="d-flex gap-2 mt-4">
        <button class="action-pill success flex-fill" type="submit" [disabled]="!nuevo.reparacion_id">
          <i class="bi bi-check2-circle me-1"></i> Guardar Presupuesto
        </button>
        <button type="button" class="action-pill warning" (click)="limpiarReparacion()">
          <i class="bi bi-arrow-clockwise me-1"></i> Limpiar
        </button>
        <button type="button" class="action-pill" (click)="seleccionarAccion('listar')">
          <i class="bi bi-arrow-left me-1"></i> Volver
        </button>
      </div>
    </form>
  </div>
</div>