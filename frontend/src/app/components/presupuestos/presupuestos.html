<div class="container py-4">

  <!-- Botonera circular -->
  <div class="d-flex justify-content-center gap-3 mb-4 flex-wrap">
    <button class="btn btn-icon btn-outline-primary"
            (click)="seleccionarAccion('listar')"
            [class.active]="selectedAction==='listar'"
            aria-label="Listar">
      <i class="bi bi-card-list fs-5"></i>
    </button>

    <button class="btn btn-icon btn-outline-success"
            (click)="seleccionarAccion('crear')"
            [class.active]="selectedAction==='crear'"
            aria-label="Crear">
      <i class="bi bi-clipboard-plus fs-5"></i>
    </button>
  </div>

  <!-- =============== LISTAR =============== -->
  <div *ngIf="selectedAction==='listar'">
    <h4 class="text-center mb-3">Presupuestos</h4>

    <!-- Skeleton primera carga -->
    <div *ngIf="loading && items.length === 0" class="list-group">
      <div class="list-group-item" *ngFor="let s of [1,2,3,4,5]">
        <div class="placeholder-glow">
          <span class="placeholder col-4 me-2"></span>
          <span class="placeholder col-2 me-2"></span>
          <span class="placeholder col-3"></span>
        </div>
        <div class="placeholder-glow mt-2">
          <span class="placeholder col-8"></span>
        </div>
      </div>
    </div>

    <!-- Estado vacío -->
    <ng-container *ngIf="!loading && items.length === 0; else listContent">
      <div class="empty-state card border-0 shadow-sm p-4 mx-auto text-center">
        <div class="empty-ico-wrap mx-auto mb-3">
          <i class="bi bi-clipboard-check"></i>
        </div>
        <h5 class="mb-1">Aún no cargaste presupuestos</h5>
        <p class="text-muted mb-3">
          Registrá tu primer presupuesto para verlo acá.
        </p>
        <div class="d-flex justify-content-center gap-2">
          <button class="btn btn-success" (click)="seleccionarAccion('crear')">
            <i class="bi bi-clipboard-plus me-1"></i> Crear presupuesto
          </button>
          <button class="btn btn-outline-primary" (click)="resetLista()">
            <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
          </button>
        </div>
      </div>
    </ng-container>

    <!-- Contenido listado -->
    <ng-template #listContent>
      <div class="list-group">
        <div *ngFor="let p of items" class="list-group-item">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">

            <!-- Izquierda: datos -->
            <div class="flex-grow-1">
              <ng-container *ngIf="editingId !== p.id; else editRow">
                <div class="fw-semibold">
                  #{{ p.id }} · Reparación: {{ p.reparacion_id }}
                  <span class="badge ms-2" [class.bg-success]="p.aceptado" [class.bg-secondary]="!p.aceptado">
                    {{ p.aceptado ? 'Aceptado' : 'Pendiente' }}
                  </span>
                </div>
                <div class="text-muted small">
                  Fecha: {{ p.fecha | date:'yyyy-MM-dd' }} ·
                  Monto: {{ (p.monto_total ?? 0) | number:'1.2-2' }}
                </div>
              </ng-container>

              <!-- Edición inline -->
              <ng-template #editRow>
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <label class="form-label small">Reparación ID</label>
                    <input type="number" class="form-control" [(ngModel)]="editBuffer.reparacion_id" />
                  </div>
                  <div class="col-6 col-md-3">
                    <label class="form-label small">Fecha</label>
                    <input type="date" class="form-control" [(ngModel)]="editBuffer.fecha" />
                  </div>
                  <div class="col-6 col-md-3">
                    <label class="form-label small">Monto total</label>
                    <input type="number" step="0.01" class="form-control" [(ngModel)]="editBuffer.monto_total" />
                  </div>
                  <div class="col-12 col-md-3 d-flex align-items-end">
                    <div class="form-check">
                      <input id="chkAceptado{{p.id}}" class="form-check-input" type="checkbox"
                             [(ngModel)]="editBuffer.aceptado" [ngModelOptions]="{standalone:true}">
                      <label class="form-check-label small" [for]="'chkAceptado'+p.id">Aceptado</label>
                    </div>
                  </div>
                </div>
              </ng-template>
            </div>

            <!-- Derecha: acciones -->
            <div class="d-flex gap-2">
              <button *ngIf="editingId !== p.id" class="btn btn-sm btn-outline-warning" (click)="startEdit(p)" title="Editar">
                <i class="bi bi-pencil-square"></i>
              </button>

              <ng-container *ngIf="editingId === p.id">
                <button class="btn btn-sm btn-success" (click)="saveEdit(p.id)" title="Guardar">
                  <i class="bi bi-check-lg"></i>
                </button>
                <button class="btn btn-sm btn-secondary" (click)="cancelEdit()" title="Cancelar">
                  <i class="bi bi-x-lg"></i>
                </button>
              </ng-container>

              <button class="btn btn-sm btn-outline-danger" (click)="eliminar(p.id)" title="Eliminar">
                <i class="bi bi-trash"></i>
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Loader incremental -->
      <div class="text-center mt-3" *ngIf="loading && items.length > 0">
        <div class="spinner-border text-primary" role="status"></div>
      </div>

      <!-- Fin de listado -->
      <div class="text-center mt-3 text-muted small"
           *ngIf="!loading && lastPage && items.length">
        Llegaste al final.
      </div>

      <!-- CTA si hay pocos ítems -->
      <div *ngIf="!loading && items.length && items.length < 3" class="text-center mt-3">
        <button class="btn btn-outline-success" (click)="seleccionarAccion('crear')">
          <i class="bi bi-clipboard-plus me-1"></i> Registrar nuevo presupuesto
        </button>
      </div>
    </ng-template>
  </div>

  <!-- =============== CREAR =============== -->
  <div *ngIf="selectedAction==='crear'">
    <h4 class="text-center mb-3">Registrar Presupuesto</h4>

    <form (ngSubmit)="crear()" class="mx-auto" style="max-width: 680px;">
      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label">Reparación ID</label>
          <input type="number" class="form-control" [(ngModel)]="nuevo.reparacion_id" name="reparacion_id" required />
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-control" [(ngModel)]="nuevo.fecha" name="fecha" required />
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Monto total</label>
          <input type="number" min="0" step="0.01" class="form-control" [(ngModel)]="nuevo.monto_total" name="monto_total" required />
        </div>
        <div class="col-12">
          <div class="form-check">
            <input id="chkAceptadoNuevo" class="form-check-input" type="checkbox" [(ngModel)]="nuevo.aceptado" name="aceptado">
            <label for="chkAceptadoNuevo" class="form-check-label">Aceptado</label>
          </div>
        </div>
      </div>

      <button class="btn btn-success w-100 mt-3" type="submit">
        <i class="bi bi-check2-circle me-1"></i> Guardar
      </button>
    </form>
  </div>
</div>
