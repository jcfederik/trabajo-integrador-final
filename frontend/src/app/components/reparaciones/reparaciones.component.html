<div class="container py-4">
  <!-- Píldoras de acción -->
  <div class="d-flex justify-content-center gap-3 mb-4 flex-wrap">
    <button class="action-pill" (click)="seleccionarAccion('listar')" [class.active]="isListar()">
      <i class="bi bi-list"></i> Listar
    </button>
    <button class="action-pill success" (click)="seleccionarAccion('crear')" [class.active]="isCrear()">
      <i class="bi bi-plus-circle"></i> Crear
    </button>
  </div>

  <!-- LISTAR -->
  <div *ngIf="isListar()">
    <h4 class="text-center mb-3">Reparaciones</h4>
    
    <!-- Indicador de búsqueda -->
    <div *ngIf="searchTerm" class="alert alert-info d-flex justify-content-between align-items-center">
      <span>Mostrando {{ reparacionesFiltradas.length }} de {{ reparacionesAll.length }} reparaciones</span>
      <button (click)="limpiarBusqueda()" class="btn btn-sm btn-outline-secondary">× Limpiar</button>
    </div>

    <!-- Estados vacíos -->
    <div *ngIf="!loading && reparacionesFiltradas.length === 0 && !searchTerm" class="empty-state">
      <div class="icon-wrap">
        <i class="bi bi-tools"></i>
      </div>
      <h5>Sin reparaciones por ahora</h5>
      <p class="text-muted mb-3">Registrá tu primera reparación para comenzar.</p>
      <button class="btn btn-primary" (click)="seleccionarAccion('crear')">
        <i class="bi bi-plus-circle me-2"></i> Nueva reparación
      </button>
    </div>

    <div *ngIf="searchTerm && reparacionesFiltradas.length === 0" class="empty-state">
      <div class="icon-wrap">
        <i class="bi bi-search"></i>
      </div>
      <h5>No se encontraron reparaciones</h5>
      <p class="text-muted">No hay resultados que coincidan con "{{ searchTerm }}"</p>
      <button class="btn btn-outline-primary" (click)="limpiarBusqueda()">
        <i class="bi bi-arrow-left me-2"></i> Ver todas las reparaciones
      </button>
    </div>

    <!-- Lista de reparaciones -->
    <div class="list-group" *ngIf="reparacionesFiltradas.length > 0">
      <div *ngFor="let r of reparacionesFiltradas" class="list-group-item" [class.editing]="editingId === r.id">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">
          
          <!-- Datos principales -->
          <div class="flex-grow-1 w-100">
            <ng-container *ngIf="editingId !== r.id; else editRow">
              
              <!-- Vista normal -->
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="fw-semibold text-break">
                  #{{ r.id }} — {{ r.descripcion }}
                </div>
                <div class="ms-3 flex-shrink-0">
                  <span class="badge" [class]="getEstadoBadgeClass(r.estado)">
                    {{ getEstadoDisplayText(r.estado) }}
                  </span>
                </div>
              </div>
              
              <div class="text-muted small">
                <div class="row g-2">
                  <div class="col-sm-6 col-md-4">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-person me-2 text-primary"></i>
                      <span><strong>Cliente:</strong> {{ getClienteNombre(r) }}</span>
                    </div>

                    <div class="d-flex align-items-center" *ngIf="r.fecha_estimada">
                    <i class="bi bi-calendar-check me-2 text-success"></i>
                    <span><strong>Estimada:</strong> {{ r.fecha_estimada | date:'dd/MM/yyyy' }}</span>
                  </div>


                  </div>
                  <div class="col-sm-6 col-md-4">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-pc me-2 text-primary"></i>
                      <span><strong>Equipo:</strong> {{ getEquipoNombre(r) }}</span>
                    </div>
                  </div>
                  <div class="col-sm-6 col-md-4">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-person-gear me-2 text-primary"></i>
                      <span><strong>Técnico:</strong> {{ getTecnicoNombre(r) }}</span>
                    </div>
                  </div>
                  <div class="col-sm-6 col-md-8">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-calendar me-2 text-primary"></i>
                      <span><strong>Fecha:</strong> {{ r.fecha | date:'dd/MM/yyyy' }}</span>
                    </div>
                  </div>
                  
                  <!-- Repuestos asignados -->
                  <div class="col-12">
                    <div class="d-flex align-items-center mt-2">
                      <i class="bi bi-tools me-2 text-info"></i>
                      <span><strong>Repuestos:</strong> 
                        <span *ngIf="r.repuestos && r.repuestos.length > 0; else sinRepuestos">
                          <span *ngIf="r.repuestos.length <= 3">
                            <span *ngFor="let repuesto of r.repuestos; let last = last">
                              {{ repuesto.nombre }} ({{ repuesto.pivot?.cantidad || 1 }}){{ !last ? ', ' : '' }}
                            </span>
                          </span>
                          <span *ngIf="r.repuestos.length > 3">
                            {{ r.repuestos.length }} repuestos asignados
                            <button class="btn btn-sm btn-outline-info ms-2" 
                                    (click)="verRepuestosModal(r)"
                                    title="Ver todos los repuestos">
                              <i class="bi bi-eye"></i> Ver todos
                            </button>
                          </span>
                        </span>
                        <ng-template #sinRepuestos>
                          <span class="text-muted">Aún no asignados</span>
                        </ng-template>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- Edición inline -->
            <ng-template #editRow>
              <div class="row g-3">
                <!-- Descripción -->
                <div class="col-12">
                  <label class="form-label small fw-semibold">Descripción de la reparación</label>
                  <textarea 
                    class="form-control" 
                    [(ngModel)]="editBuffer.descripcion" 
                    rows="2"
                    placeholder="Describe el problema o trabajo a realizar..."
                  ></textarea>
                </div>

                <!-- Selectores de búsqueda -->
                <div class="col-12">
                  <div class="search-selectors-grid justify-content-center">

                    <!-- Cliente en edición -->
                    <div class="search-selector-column text-center">
                      <label class="form-label small fw-semibold">Cliente</label>
                      <div class="cliente-display-box" *ngIf="clienteEditSeleccionado">
                        <div class="selected-item-display">
                          <i class="bi bi-person-check text-success"></i>
                          <span class="ms-2">{{ clienteEditSeleccionado.nombre }}</span>
                        </div>
                        <small class="text-muted d-block mt-1">Cliente actual</small>
                      </div>
                      <div class="cliente-display-box text-muted" *ngIf="!clienteEditSeleccionado">
                        <i class="bi bi-person-x"></i>
                        <small>No seleccionado</small>
                      </div>
                    </div>

                    <!-- Equipo en edición -->
                    <div class="search-selector-column text-center">
                      <label class="form-label small fw-semibold">Equipo</label>
                      <div class="search-selector-container mx-auto" 
                           [class.invalid]="clienteEditSeleccionado && !equipoEditSeleccionado"
                           [class.valid]="equipoEditSeleccionado"
                           style="max-width: 300px;">
                        <app-search-selector
                          #equipoEditSelector
                          type="equipo"
                          [placeholder]="clienteEditSeleccionado ? 'Buscar equipo...' : 'Seleccione cliente'"
                          [disabled]="!clienteEditSeleccionado"
                          [selectedItem]="equipoEditSeleccionado"
                          [preloadOnFocus]="true"
                          (search)="buscarEquiposEdit($event)"
                          (selectItem)="seleccionarEquipoEdit($event)"
                          (clearSelection)="limpiarEquipoEdit()"
                          (focus)="cargarEquiposInicialesEdit()"
                          (loadInitialData)="cargarEquiposInicialesEdit()"
                        ></app-search-selector>
                      </div>
                      
                      <div *ngIf="!clienteEditSeleccionado" class="no-equipos-message text-center">
                        <i class="bi bi-exclamation-triangle"></i>
                        Primero selecciona un cliente
                      </div>
                      
                      <div *ngIf="clienteEditSeleccionado && !equipoEditSeleccionado && hasEquipoEditSelectorMessage()" 
                           class="no-equipos-message text-center">
                        <i class="bi bi-search"></i>
                        {{ getEquipoEditSelectorMessage() }}
                      </div>
                      
                      <small class="context-help info text-center d-block" *ngIf="equipoEditSeleccionado">
                        <i class="bi bi-check-circle"></i> Equipo seleccionado
                      </small>
                    </div>

                    <!-- Técnico en edición -->
                    <div class="search-selector-column text-center">
                      <label class="form-label small fw-semibold">Técnico</label>
                      <div class="search-selector-container mx-auto" 
                           [class.invalid]="!tecnicoEditSeleccionado"
                           [class.valid]="tecnicoEditSeleccionado"
                           style="max-width: 300px;">
                        <app-search-selector
                          #tecnicoEditSelector
                          type="tecnico"
                          placeholder="Buscar técnico..."
                          [selectedItem]="tecnicoEditSeleccionado"
                          [preloadOnFocus]="true"
                          (search)="buscarTecnicosEdit($event)"
                          (selectItem)="seleccionarTecnicoEdit($event)"
                          (clearSelection)="limpiarTecnicoEdit()"
                          (focus)="cargarTecnicosInicialesEdit()"
                          (loadInitialData)="cargarTecnicosInicialesEdit()"
                        ></app-search-selector>
                      </div>
                      <small class="context-help info text-center d-block" *ngIf="!tecnicoEditSeleccionado">
                        <i class="bi bi-info-circle"></i> Asigna un técnico
                      </small>
                      <small class="context-help success text-center d-block" *ngIf="tecnicoEditSeleccionado">
                        <i class="bi bi-check-circle"></i> Técnico asignado
                      </small>
                    </div>
                  </div>
                </div>
                
              <!-- Fecha y Estado - CENTRADOS -->
              <div class="col-12 col-md-6 mx-auto">
                <label class="form-label small fw-semibold">Fecha</label>
                <input 
                  type="date" 
                  class="form-control text-center" 
                  [(ngModel)]="editBuffer.fecha"
                />
              </div>

              <div class="col-12 col-md-6 mx-auto">
                <label class="form-label small fw-semibold">Fecha Estimada (opcional)</label>
                <input 
                  type="date" 
                  class="form-control text-center" 
                  [(ngModel)]="editBuffer.fecha_estimada"
                />
              </div>

              <div class="col-12 col-md-6 mx-auto">
                <label class="form-label small fw-semibold">Estado</label>
                <select 
                  class="form-control text-center" 
                  [(ngModel)]="editBuffer.estado"
                >
                  <option value="pendiente">Pendiente</option>
                  <option value="en proceso">En proceso</option>
                  <option value="finalizada">Finalizada</option>
                  <option value="cancelada">Cancelada</option>  
                </select>
              </div>

                <!-- Información de ayuda -->
                <div class="col-12">
                  <div class="alert alert-info py-2 text-center">
                    <i class="bi bi-info-circle me-2"></i>
                    <small>Completá todos los campos para guardar los cambios</small>
                  </div>
                </div>
              </div>
            </ng-template>
          </div>

          <!-- Botones de acción -->
          <div class="d-flex gap-2 align-self-start flex-shrink-0 mt-2 mt-md-0">
            <button 
              *ngIf="editingId !== r.id" 
              class="btn btn-sm btn-outline-warning" 
              (click)="startEdit(r)"
              title="Editar reparación"
            >
              <i class="bi bi-pencil-square"></i>
            </button>
          
            <button 
              *ngIf="editingId !== r.id" class="btn btn-sm btn-outline-info" 
              (click)="abrirModalRepuestos(r)" title="Gestionar repuestos">
              <i class="bi bi-tools"></i>
            </button>

            <ng-container *ngIf="editingId === r.id">
              <button 
                class="btn btn-sm btn-success" 
                (click)="saveEdit(r.id)"
                title="Guardar cambios"
                [disabled]="!editBuffer.descripcion || !editBuffer.equipo_id || !editBuffer.usuario_id || !editBuffer.fecha || !editBuffer.estado"
              >
                <i class="bi bi-check-lg"></i>
              </button>
              <button 
                class="btn btn-sm btn-secondary" 
                (click)="cancelEdit()"
                title="Cancelar edición"
              >
                <i class="bi bi-x-lg"></i>
              </button>
            </ng-container>
            
            <button 
              class="btn btn-sm btn-outline-danger" 
              (click)="eliminar(r.id)"
              title="Eliminar reparación"
            >
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div class="text-center mt-3" *ngIf="loading">
      <div class="spinner-border text-primary"></div>
      <div class="mt-2 text-muted">Cargando más reparaciones...</div>
    </div>
  </div>

  <!-- CREAR -->
  <div *ngIf="isCrear()">
    <h4 class="text-center mb-4">Registrar Reparación</h4>
    
    <!-- Grid de búsquedas -->
    <div class="search-selectors-grid">
      <!-- Cliente -->
      <div class="search-selector-column">
        <label class="form-label fw-semibold">Cliente</label>
        <div class="search-selector-container" [class.invalid]="!clienteSeleccionado">
          <app-search-selector
            #clienteSelector
            type="cliente"
            placeholder="Buscar cliente por nombre..."
            [selectedItem]="clienteSeleccionado"
            [preloadOnFocus]="true"
            (search)="buscarClientes($event)"
            (selectItem)="seleccionarCliente($event)"
            (clearSelection)="limpiarCliente()"
            (focus)="onFocusClientes()"
            (loadInitialData)="cargarClientesIniciales()"
          ></app-search-selector>
        </div>
        <small class="context-help info" *ngIf="!clienteSeleccionado">
          <i class="bi bi-info-circle"></i> Selecciona un cliente para continuar
        </small>
      </div>

      <!-- Equipo -->
      <div class="search-selector-column">
        <label class="form-label fw-semibold">Equipo</label>
        <div class="search-selector-container" 
             [class.invalid]="clienteSeleccionado && !equipoSeleccionado"
             [class.valid]="equipoSeleccionado">
          <app-search-selector
            #equipoSelector
            type="equipo"
            [placeholder]="clienteSeleccionado ? 'Buscar equipo del cliente...' : 'Primero seleccione un cliente'"
            [disabled]="!clienteSeleccionado"
            [selectedItem]="equipoSeleccionado"
            [preloadOnFocus]="true"
            (search)="buscarEquipos($event)"
            (selectItem)="seleccionarEquipo($event)"
            (clearSelection)="limpiarEquipo()"
            (focus)="onFocusEquipos()"
            (loadInitialData)="cargarEquiposIniciales()"
          ></app-search-selector>
        </div>
        
        <div *ngIf="!clienteSeleccionado" class="no-equipos-message">
          <i class="bi bi-exclamation-triangle"></i>
          Primero selecciona un cliente
        </div>
        
        <div *ngIf="clienteSeleccionado && !equipoSeleccionado && equipoSelector?.hasSearched && equipoSelector?.suggestions?.length === 0" 
             class="no-equipos-message">
          <i class="bi bi-search"></i>
          Este cliente no tiene equipos registrados
        </div>
        
        <small class="context-help info" *ngIf="equipoSeleccionado">
          <i class="bi bi-check-circle"></i> Equipo seleccionado
        </small>
      </div>

      <!-- Técnico -->
      <div class="search-selector-column">
        <label class="form-label fw-semibold">Técnico</label>
        <div class="search-selector-container" 
             [class.invalid]="!tecnicoSeleccionado"
             [class.valid]="tecnicoSeleccionado">
          <app-search-selector
            #tecnicoSelector
            type="tecnico"
            placeholder="Buscar técnico por nombre..."
            [selectedItem]="tecnicoSeleccionado"
            [preloadOnFocus]="true"
            (search)="buscarTecnicos($event)"
            (selectItem)="seleccionarTecnico($event)"
            (clearSelection)="limpiarTecnico()"
            (focus)="onFocusTecnicos()"
            (loadInitialData)="cargarTecnicosIniciales()"
          ></app-search-selector>
        </div>
        <small class="context-help info" *ngIf="!tecnicoSeleccionado">
          <i class="bi bi-info-circle"></i> Asigna un técnico responsable
        </small>
      </div>
    </div>

    <!-- Detalles de la reparación -->
    <div class="reparacion-details">
      <h5 class="mb-3">Detalles de la Reparación</h5>
      
      <form (ngSubmit)="crear()" class="row g-3">
        <!-- Descripción -->
        <div class="col-12">
          <label class="form-label fw-semibold">Descripción de la reparación</label>
          <textarea 
            class="form-control" 
            [(ngModel)]="nuevo.descripcion" 
            name="descripcion" 
            rows="3" 
            placeholder="Describe el problema o trabajo a realizar..."
            required
          ></textarea>
          <small class="context-help">Describe claramente el problema a resolver</small>
        </div>

        <!-- Fecha y Estado -->
        <div class="col-12 col-md-6">
          <label class="form-label fw-semibold">Fecha</label>
          <input 
            type="date" 
            class="form-control" 
            [(ngModel)]="nuevo.fecha" 
            name="fecha" 
            required 
          />
        </div>

        <div class="col-12 col-md-6">
        <label class="form-label fw-semibold">Fecha Estimada (opcional)</label>
        <input 
          type="date" 
          class="form-control" 
          [(ngModel)]="nuevo.fecha_estimada" 
          name="fecha_estimada"
        />
        <small class="text-muted">Esta fecha es opcional</small>
      </div>

        
        <div class="col-12 col-md-6">
          <label class="form-label fw-semibold">Estado</label>
          <select 
            class="form-control" 
            [(ngModel)]="nuevo.estado" 
            name="estado" 
            required
          >
            <option value="pendiente">Pendiente</option>
            <option value="en proceso">En proceso</option>
            <option value="finalizada">Finalizada</option>
            <option value="cancelada">Cancelada</option>
          </select>
        </div>

        <!-- Repuestos a asignar -->
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="bi bi-tools me-2"></i>Repuestos a asignar
              </h6>
            </div>
            <div class="card-body">
              <!-- Lista de repuestos seleccionados -->
              <div *ngIf="repuestosSeleccionadosCrear.length > 0" class="mb-3">
                <h6 class="text-success">Repuestos asignados:</h6>
                <div *ngFor="let repuesto of repuestosSeleccionadosCrear" class="alert alert-success py-2 mb-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong>{{ repuesto.nombre }}</strong>
                      <small class="text-muted ms-2">
                        Cantidad: {{ repuesto.cantidad }} · 
                        Costo: {{ formatearPrecio(repuesto.costo_base) }} · 
                        Stock disponible: <span [class]="getStockClass(repuesto.stock)">{{ repuesto.stock }}</span>
                      </small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" 
                            (click)="removerRepuestoCrear(repuesto.id)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Selector de repuestos -->
              <div class="mb-3">
                <label class="form-label fw-semibold">Agregar repuesto</label>
                <div class="search-selector-container">
                  <app-search-selector
                    #repuestoCrearSelector
                    type="repuesto"
                    placeholder="Buscar repuesto por nombre..."
                    [selectedItem]="null"
                    [preloadOnFocus]="true"
                    (search)="buscarRepuestosCrear($event)"
                    (selectItem)="seleccionarRepuestoCrear($event)"
                    (clearSelection)="limpiarRepuestoCrear()"
                    (focus)="cargarRepuestosInicialesCrear()"
                    (loadInitialData)="cargarRepuestosInicialesCrear()"
                  ></app-search-selector>
                </div>
              </div>

              <!-- Cantidad para el repuesto seleccionado -->
              <div *ngIf="repuestoSeleccionadoCrear" class="row g-2">
                <div class="col-md-6">
                  <label class="form-label small fw-semibold">Cantidad</label>
                  <div class="input-group">
                    <input type="number" 
                           class="form-control" 
                           [(ngModel)]="cantidadRepuestoCrear"
                           [max]="repuestoSeleccionadoCrear.stock"
                           min="1"
                           name="cantidadRepuesto"
                           placeholder="Cantidad">
                    <span class="input-group-text">/ {{ repuestoSeleccionadoCrear.stock }} disponibles</span>
                  </div>
                  <small class="text-muted">Máximo: {{ repuestoSeleccionadoCrear.stock }} unidades</small>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                  <button type="button" class="btn btn-success w-100" 
                          (click)="agregarRepuestoCrear()"
                          [disabled]="!cantidadRepuestoCrear || cantidadRepuestoCrear < 1 || cantidadRepuestoCrear > repuestoSeleccionadoCrear.stock">
                    <i class="bi bi-plus-circle me-1"></i> Agregar repuesto
                  </button>
                </div>
              </div>

              <!-- Mensaje de stock insuficiente -->
              <div *ngIf="repuestoSeleccionadoCrear && cantidadRepuestoCrear > repuestoSeleccionadoCrear.stock" 
                   class="alert alert-warning mt-2">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Stock insuficiente. Solo hay {{ repuestoSeleccionadoCrear.stock }} unidades disponibles.
              </div>
            </div>
          </div>
        </div>

        <!-- Resumen de selección -->
        <div class="col-12" *ngIf="clienteSeleccionado || equipoSeleccionado || tecnicoSeleccionado || repuestosSeleccionadosCrear.length > 0">
          <div class="alert alert-info">
            <h6 class="alert-heading mb-2">
              <i class="bi bi-clipboard-check me-2"></i>Resumen de la reparación
            </h6>
            <div class="row small">
              <div class="col-md-4" *ngIf="clienteSeleccionado">
                <strong>Cliente:</strong> {{ clienteSeleccionado.nombre }}
              </div>
              <div class="col-md-4" *ngIf="equipoSeleccionado">
                <strong>Equipo:</strong> {{ equipoSeleccionado.descripcion }}
              </div>
              <div class="col-md-4" *ngIf="tecnicoSeleccionado">
                <strong>Técnico:</strong> {{ tecnicoSeleccionado.nombre }}
              </div>
            </div>
            
            <!-- Repuestos en resumen -->
            <div *ngIf="repuestosSeleccionadosCrear.length > 0" class="mt-2">
              <strong>Repuestos:</strong>
              <div *ngFor="let repuesto of repuestosSeleccionadosCrear" class="ms-2">
                • {{ repuesto.nombre }} ({{ repuesto.cantidad }} unidades)
              </div>
            </div>
          </div>
        </div>

        <!-- Botón de envío -->
        <div class="col-12">
          <button 
            class="btn btn-success w-100 py-2" 
            type="submit" 
            [disabled]="!isFormValid()"
          >
            <i class="bi bi-check-lg me-2"></i> 
            {{ getTextoBotonCrear() }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para gestionar repuestos -->
<div *ngIf="mostrarModalRepuestos && reparacionSeleccionada" class="modal-backdrop fade show"></div>
<div *ngIf="mostrarModalRepuestos && reparacionSeleccionada" 
     class="modal fade show d-block" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-tools me-2"></i>
          Repuestos para Reparación #{{ reparacionSeleccionada.id }}
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModalRepuestos()"></button>
      </div>
      
      <div class="modal-body">
        <!-- Repuestos asignados -->
        <div class="mb-4">
          <h6 class="border-bottom pb-2">Repuestos asignados</h6>
          
          <div *ngIf="cargandoRepuestosAsignados" class="text-center py-4">
            <div class="spinner-border text-primary"></div>
            <div class="mt-2 text-muted">Cargando repuestos asignados...</div>
          </div>
          
          <div *ngIf="!cargandoRepuestosAsignados && repuestosAsignados.length === 0" class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No hay repuestos asignados a esta reparación.
          </div>
          
          <div *ngIf="!cargandoRepuestosAsignados && repuestosAsignados.length > 0">
            <div *ngFor="let repuesto of repuestosAsignados" class="card mb-2">
              <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong class="d-block">{{ repuesto.nombre }}</strong>
                    <small class="text-muted">
                      Cantidad: {{ repuesto.pivot.cantidad }} · 
                      Costo unitario: {{ formatearPrecio(repuesto.pivot.costo_unitario) }} · 
                      Total: {{ formatearPrecio(repuesto.pivot.cantidad * repuesto.pivot.costo_unitario) }}
                    </small>
                  </div>
                  <button class="btn btn-sm btn-outline-danger" 
                          (click)="removerRepuesto(repuesto)"
                          title="Remover repuesto">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Repuestos disponibles -->
        <div>
          <h6 class="border-bottom pb-2">Repuestos disponibles</h6>
          
          <div *ngIf="cargandoRepuestosDisponibles" class="text-center py-4">
            <div class="spinner-border text-primary"></div>
            <div class="mt-2 text-muted">Cargando repuestos disponibles...</div>
          </div>
          
          <div *ngIf="!cargandoRepuestosDisponibles && repuestosDisponibles.length === 0" class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No hay repuestos disponibles en el inventario.
          </div>
          
          <div *ngIf="!cargandoRepuestosDisponibles && repuestosDisponibles.length > 0">
            <div *ngFor="let repuesto of repuestosDisponibles" class="card mb-2">
              <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="flex-grow-1">
                    <strong class="d-block">{{ repuesto.nombre }}</strong>
                    <small class="text-muted">
                      Stock: <span [class]="getStockClass(repuesto.stock)">{{ repuesto.stock }}</span> · 
                      Costo: {{ formatearPrecio(repuesto.costo_base) }}
                    </small>
                  </div>
                  <div class="d-flex align-items-center gap-2 ms-3">
                    <div class="input-group input-group-sm" style="width: 140px;">
                      <input type="number" 
                             [(ngModel)]="repuesto.cantidadSeleccionada"
                             min="1" 
                             [max]="repuesto.stock"
                             class="form-control" 
                             placeholder="Cant."
                             [class.is-invalid]="repuesto.cantidadSeleccionada > repuesto.stock">
                      <button class="btn btn-success" 
                              (click)="asignarRepuesto(repuesto)"
                              [disabled]="!repuesto.cantidadSeleccionada || repuesto.cantidadSeleccionada < 1 || repuesto.cantidadSeleccionada > repuesto.stock"
                              title="Asignar repuesto">
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div *ngIf="repuesto.cantidadSeleccionada > repuesto.stock" class="text-danger small mt-1">
                  <i class="bi bi-exclamation-triangle"></i>
                  La cantidad no puede ser mayor al stock disponible
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalRepuestos()">
          <i class="bi bi-x-circle me-1"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para ver todos los repuestos -->
<div *ngIf="mostrarModalVerRepuestos && reparacionSeleccionada" class="modal-backdrop fade show"></div>
<div *ngIf="mostrarModalVerRepuestos && reparacionSeleccionada" 
     class="modal fade show d-block" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-tools me-2"></i>
          Todos los repuestos - Reparación #{{ reparacionSeleccionada.id }}
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModalVerRepuestos()"></button>
      </div>
      
      <div class="modal-body">
        <div *ngIf="cargandoRepuestosAsignados" class="text-center py-5">
          <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
          <div class="mt-3 text-muted">Cargando repuestos...</div>
        </div>
        
        <div *ngIf="!cargandoRepuestosAsignados">
          <div *ngIf="reparacionSeleccionada.repuestos && reparacionSeleccionada.repuestos.length > 0; else sinRepuestosVer">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Repuesto</th>
                    <th>Cantidad</th>
                    <th>Costo Unitario</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let repuesto of reparacionSeleccionada.repuestos">
                    <td>
                      <strong>{{ repuesto.nombre }}</strong>
                    </td>
                    <td>{{ repuesto.pivot?.cantidad || 1 }}</td>
                    <td>{{ formatearPrecio(repuesto.pivot?.costo_unitario || repuesto.costo_base) }}</td>
                    <td class="fw-bold">
                      {{ formatearPrecio((repuesto.pivot?.cantidad || 1) * (repuesto.pivot?.costo_unitario || repuesto.costo_base)) }}
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="table-primary">
                    <td colspan="3" class="text-end"><strong>Total general:</strong></td>
                    <td class="fw-bold">
                      {{ formatearPrecio(calcularTotalRepuestos(reparacionSeleccionada)) }}
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          <ng-template #sinRepuestosVer>
            <div class="alert alert-info text-center">
              <i class="bi bi-info-circle me-2"></i>
              Esta reparación no tiene repuestos asignados.
            </div>
          </ng-template>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalVerRepuestos()">
          <i class="bi bi-x-circle me-1"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>