<div class="container py-4">

  <!-- Botonera como píldoras de acción -->
  <div class="botonera-principal">
    <button class="action-pill"
            (click)="seleccionarAccion('listar')"
            [class.active]="selectedAction==='listar'"
            aria-label="Listar facturas">
      <i class="bi bi-card-list"></i>
      Listar
    </button>

    <button class="action-pill success"
            (click)="seleccionarAccion('crear')"
            [class.active]="selectedAction==='crear'"
            aria-label="Crear factura">
      <i class="bi bi-file-earmark-plus"></i>
      Crear
    </button>

    <button class="action-pill"
            (click)="abrirModalExportacion()"
            [disabled]="!facturas.length"
            aria-label="Exportar a PDF">
      <i class="bi bi-printer"></i>
      Exportar
    </button>
  </div>

  <!-- ================= LISTAR ================= -->
  <div *ngIf="selectedAction==='listar'">
    <h4 class="titulo-seccion">Facturas</h4>

    <!-- Skeleton de carga (primera página) -->
    <div *ngIf="loading && facturas.length === 0" class="skeleton-container">
      <div class="skeleton-item" *ngFor="let s of [1,2,3,4,5]">
        <div class="skeleton-line-container">
          <span class="skeleton-line short"></span>
          <span class="skeleton-line medium"></span>
          <span class="skeleton-line long"></span>
        </div>
        <div class="skeleton-line-container">
          <span class="skeleton-line full"></span>
        </div>
      </div>
    </div>

    <!-- Estado vacío (sin datos) -->
    <ng-container *ngIf="!loading && facturas.length === 0; else listContent">
      <div class="empty-state">
        <div class="empty-icon">
          <i class="bi bi-receipt"></i>
        </div>
        <h5 class="empty-title">Aún no cargaste facturas</h5>
        <p class="empty-description">
          Registrá tu primera factura para empezar a ver el historial acá.
        </p>
        <div class="empty-actions">
          <button class="action-pill success" (click)="seleccionarAccion('crear')">
            <i class="bi bi-file-earmark-plus me-1"></i> Crear factura
          </button>
          <button class="action-pill" (click)="resetLista()">
            <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
          </button>
        </div>
      </div>
    </ng-container>

    <!-- Contenido de lista -->
    <ng-template #listContent>
      <div class="lista-facturas">
        <div *ngFor="let f of facturas" class="item-factura">
          <div class="item-contenido">
            <!-- Columna izquierda: datos -->
            <div class="item-datos">
              <ng-container *ngIf="editingId !== f.id; else editRow">
                <div class="factura-numero">
                  {{ f.numero }} <span class="factura-letra">({{ f.letra }})</span>
                </div>
                <div class="factura-info">
                  Fecha: {{ f.fecha | date:'yyyy-MM-dd' }} ·
                  Monto: {{ (f.monto_total || 0) | number:'1.2-2' }} ·
                  Presupuesto: {{ f.presupuesto_id }}
                </div>
                <div class="factura-detalle">
                  <span class="detalle-label">Detalle:</span> {{ f.detalle || '—' }}
                </div>
              </ng-container>

              <!-- Edición inline -->
              <ng-template #editRow>
                <div class="formulario-edicion">
                  <div class="fila-campos">
                    
                    <!-- BÚSQUEDA DE PRESUPUESTO EN EDICIÓN -->
                    <div class="campo-grupo ancho-completo">
                      <label class="etiqueta-campo">Presupuesto <span class="campo-obligatorio">*</span></label>
                      <div class="contenedor-busqueda">
                        <input type="text" 
                              class="input-busqueda" 
                              [(ngModel)]="editBuffer.presupuestoBusqueda" 
                              (input)="onBuscarPresupuesto(editBuffer.presupuestoBusqueda, true)"
                              (focus)="mostrandoPresupuestos = true"
                              (blur)="ocultarPresupuestos()"
                              placeholder="Buscar presupuesto por ID, reparación, cliente..."
                              name="presupuestoBusquedaEdit"
                              required
                              autocomplete="off" />
                        
                        <!-- Limpiar selección -->
                        <button *ngIf="editBuffer.presupuestoBusqueda" 
                                type="button" 
                                class="boton-limpiar"
                                (click)="limpiarPresupuesto(true)" 
                                title="Limpiar búsqueda">
                          <i class="bi bi-x"></i>
                        </button>

                        <!-- Dropdown de sugerencias -->
                        <div *ngIf="mostrandoPresupuestos && presupuestosSugeridos.length > 0" 
                            class="menu-sugerencias">
                          <div class="cabecera-sugerencias">
                            <i class="bi bi-search"></i>
                            Presupuestos encontrados
                            <span class="contador-sugerencias">{{ presupuestosSugeridos.length }}</span>
                          </div>
                          <div *ngFor="let presupuesto of presupuestosSugeridos" 
                              class="item-sugerencia"
                              (mousedown)="seleccionarPresupuesto(presupuesto, true); cerrarMenuSugerencias()">
                            <div class="contenido-sugerencia">
                              <strong>{{ presupuesto.displayText }}</strong>
                              <div class="detalles-sugerencia">
                                Reparación: {{ presupuesto.reparacion_descripcion }} | 
                                Estado: {{ presupuesto.aceptado ? 'Aceptado' : 'Pendiente' }}
                              </div>
                            </div>
                            <i class="bi bi-chevron-right"></i>
                          </div>
                        </div>

                        <!-- Sin resultados -->
                        <div *ngIf="mostrandoPresupuestos && !buscandoPresupuestos && presupuestosSugeridos.length === 0 && editBuffer.presupuestoBusqueda" 
                            class="menu-sugerencias">
                          <div class="cabecera-sugerencias">
                            <i class="bi bi-search"></i>
                            Sin resultados
                          </div>
                          <div class="item-sugerencia sin-resultados">
                            <div class="contenido-sugerencia">
                              <i class="bi bi-exclamation-circle icono-advertencia"></i>
                              No se encontraron presupuestos para "{{ editBuffer.presupuestoBusqueda }}"
                            </div>
                          </div>
                        </div>

                        <!-- Estado de carga -->
                        <div *ngIf="buscandoPresupuestos" class="indicador-carga">
                          <div class="spinner-mini" role="status"></div>
                        </div>
                      </div>
                      
                      <!-- Badge de selección -->
                      <div *ngIf="editBuffer.presupuestoSeleccionado" class="badge-seleccion">
                        <i class="bi bi-check-circle"></i>
                        Presupuesto seleccionado: #{{ editBuffer.presupuestoSeleccionado.id }}
                        <small class="monto-seleccion">Monto: {{ (editBuffer.presupuestoSeleccionado.monto_total ?? 0) | number:'1.2-2' }}</small>
                      </div>
                    </div>

                    <div class="campo-grupo">
                      <label class="etiqueta-campo">Número</label>
                      <input class="control-formulario" [(ngModel)]="editBuffer.numero" />
                    </div>
                    <div class="campo-grupo">
                      <label class="etiqueta-campo">Letra</label>
                      <input class="control-formulario letra-mayuscula" maxlength="1" [(ngModel)]="editBuffer.letra" />
                    </div>
                    <div class="campo-grupo">
                      <label class="etiqueta-campo">Fecha</label>
                      <input type="date" class="control-formulario" [(ngModel)]="editBuffer.fecha" />
                    </div>
                    <div class="campo-grupo">
                      <label class="etiqueta-campo">Monto</label>
                      <input type="number" step="0.01" class="control-formulario" [(ngModel)]="editBuffer.monto_total" />
                    </div>
                    <div class="campo-grupo ancho-completo">
                      <label class="etiqueta-campo">Detalle</label>
                      <input class="control-formulario" [(ngModel)]="editBuffer.detalle" />
                    </div>
                  </div>
                </div>
              </ng-template>
            </div>

            <!-- Columna derecha: acciones -->
            <div class="item-acciones">
              <button *ngIf="editingId !== f.id" class="boton-accion boton-editar" (click)="startEdit(f)" title="Editar">
                <i class="bi bi-pencil-square"></i>
              </button>

              <ng-container *ngIf="editingId === f.id">
                <button class="boton-accion boton-guardar" (click)="saveEdit(f.id)" title="Guardar">
                  <i class="bi bi-check-lg"></i>
                </button>
                <button class="boton-accion boton-cancelar" (click)="cancelEdit()" title="Cancelar">
                  <i class="bi bi-x-lg"></i>
                </button>
              </ng-container>

              <!-- Botón para modal de pagos -->
              <button class="boton-accion boton-cobros" (click)="abrirModalCobros(f)" title="Gestionar pagos">
                <i class="bi bi-wallet2"></i>
              </button>

              <button class="boton-accion boton-eliminar" (click)="eliminar(f.id)" title="Eliminar">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Elementos de paginación -->
      <div class="cargando-mas" *ngIf="loading && facturas.length > 0">
        <div class="spinner-carga" role="status"></div>
      </div>

      <div class="fin-lista" *ngIf="!loading && lastPage && facturas.length">
        Llegaste al final.
      </div>

      <div *ngIf="!loading && facturas.length && facturas.length < 3" class="cta-agregar">
        <button class="action-pill success" (click)="seleccionarAccion('crear')">
          <i class="bi bi-file-earmark-plus me-1"></i> Registrar nueva factura
        </button>
      </div>
    </ng-template>
  </div>

  <!-- ================= CREAR ================= -->
  <div *ngIf="selectedAction==='crear'">
    <h4 class="titulo-seccion">Registrar Factura</h4>

    <form (ngSubmit)="crear()" class="formulario-crear">
      <div class="fila-campos">
        
        <!-- Búsqueda inteligente de presupuesto -->
        <div class="campo-grupo ancho-completo">
          <label class="etiqueta-campo">Presupuesto <span class="campo-obligatorio">*</span></label>
          <div class="contenedor-busqueda">
            <input type="text" 
                   class="input-busqueda" 
                   [(ngModel)]="nuevo.presupuestoBusqueda" 
                   (input)="onBuscarPresupuesto(nuevo.presupuestoBusqueda)"
                   (focus)="mostrandoPresupuestos = true"
                   (blur)="ocultarPresupuestos()"
                   placeholder="Buscar presupuesto por ID, reparación, cliente..."
                   name="presupuestoBusqueda"
                   required
                   autocomplete="off" />
            
            <!-- Limpiar selección -->
            <button *ngIf="nuevo.presupuestoBusqueda" 
                    type="button" 
                    class="boton-limpiar"
                    (click)="limpiarPresupuesto()" 
                    title="Limpiar búsqueda">
              <i class="bi bi-x"></i>
            </button>

            <!-- Dropdown de sugerencias -->
            <div *ngIf="mostrandoPresupuestos && presupuestosSugeridos.length > 0" 
                 class="menu-sugerencias">
              <div class="cabecera-sugerencias">
                <i class="bi bi-search"></i>
                Presupuestos encontrados
                <span class="contador-sugerencias">{{ presupuestosSugeridos.length }}</span>
              </div>
                <div *ngFor="let presupuesto of presupuestosSugeridos" 
                    class="item-sugerencia"
                    (mousedown)="seleccionarPresupuesto(presupuesto); cerrarMenuSugerencias()">
                  <div class="contenido-sugerencia">
                    <strong>{{ presupuesto.displayText }}</strong>
                    <div class="detalles-sugerencia">
                      Reparación: {{ presupuesto.reparacion_descripcion }} | 
                      Estado: {{ presupuesto.aceptado ? 'Aceptado' : 'Pendiente' }}
                    </div>
                  </div>
                  <i class="bi bi-chevron-right"></i>
                </div>
            </div>

            <!-- Sin resultados -->
            <div *ngIf="mostrandoPresupuestos && !buscandoPresupuestos && presupuestosSugeridos.length === 0 && nuevo.presupuestoBusqueda" 
                 class="menu-sugerencias">
              <div class="cabecera-sugerencias">
                <i class="bi bi-search"></i>
                Sin resultados
              </div>
              <div class="item-sugerencia sin-resultados">
                <div class="contenido-sugerencia">
                  <i class="bi bi-exclamation-circle icono-advertencia"></i>
                  No se encontraron presupuestos para "{{ nuevo.presupuestoBusqueda }}"
                </div>
              </div>
            </div>

            <!-- Estado de carga -->
            <div *ngIf="buscandoPresupuestos" class="indicador-carga">
              <div class="spinner-mini" role="status"></div>
            </div>
          </div>
          
          <!-- Badge de selección -->
          <div *ngIf="nuevo.presupuestoSeleccionado" class="badge-seleccion">
            <i class="bi bi-check-circle"></i>
            Presupuesto seleccionado: #{{ nuevo.presupuestoSeleccionado.id }}
            <small class="monto-seleccion">Monto: {{ (nuevo.presupuestoSeleccionado.monto_total ?? 0) | number:'1.2-2' }}</small>
          </div>
        </div>

        <div class="campo-grupo">
          <label class="etiqueta-campo">Número</label>
          <input class="control-formulario" [(ngModel)]="nuevo.numero" name="numero" placeholder="F0001-00000001" required />
        </div>
        <div class="campo-grupo">
          <label class="etiqueta-campo">Letra</label>
          <input class="control-formulario letra-mayuscula" maxlength="1" [(ngModel)]="nuevo.letra" name="letra" required />
        </div>
        <div class="campo-grupo">
          <label class="etiqueta-campo">Fecha</label>
          <input type="date" class="control-formulario" [(ngModel)]="nuevo.fecha" name="fecha" required />
        </div>
        <div class="campo-grupo">
          <label class="etiqueta-campo">Monto total</label>
          <input type="number" min="0" step="0.01" class="control-formulario" [(ngModel)]="nuevo.monto_total" name="monto_total" required />
        </div>
        <div class="campo-grupo ancho-completo">
          <label class="etiqueta-campo">Detalle (opcional)</label>
          <input class="control-formulario" [(ngModel)]="nuevo.detalle" name="detalle" />
        </div>

        <!-- Información del presupuesto seleccionado -->
        <div *ngIf="nuevo.presupuestoSeleccionado" class="campo-grupo ancho-completo">
          <div class="tarjeta-informacion">
            <div class="contenido-tarjeta">
              <h6 class="titulo-tarjeta">
                <i class="bi bi-info-circle icono-informativo"></i>
                Información del Presupuesto Seleccionado
              </h6>
              <div class="grid-informacion">
                <div class="item-informacion">
                  <strong>ID:</strong> {{ nuevo.presupuestoSeleccionado.id }}
                </div>
                <div class="item-informacion">
                  <strong>Monto:</strong> {{ (nuevo.presupuestoSeleccionado.monto_total ?? 0) | number:'1.2-2' }}
                </div>
                <div class="item-informacion">
                  <strong>Estado:</strong> 
                  <span [class]="'badge-estado ' + (nuevo.presupuestoSeleccionado.aceptado ? 'estado-aceptado' : 'estado-pendiente')">
                    {{ nuevo.presupuestoSeleccionado.aceptado ? 'Aceptado' : 'Pendiente' }}
                  </span>
                </div>
                <div class="item-informacion">
                  <strong>Reparación:</strong> {{ getDescripcionReparacion(nuevo.presupuestoSeleccionado.reparacion_id) }}
                </div>
                <div class="item-informacion">
                  <strong>Fecha presupuesto:</strong> {{ nuevo.presupuestoSeleccionado.fecha | date:'dd/MM/yyyy' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button class="boton-enviar" type="submit" [disabled]="!nuevo.presupuesto_id">
        <i class="bi bi-check2-circle icono-boton"></i> Guardar Factura
      </button>
    </form>
  </div>

  <!-- MODALES -->
  
  <!-- Modal de Exportación -->
  <app-export-modal 
      *ngIf="mostrarModalExportacion"
      (cerrar)="cerrarModalExportacion()"
      (exportarTodas)="exportarTodasFacturas()"> 
  </app-export-modal>

  <!-- Modal de Cobros -->
  <app-cobros-modal 
      #cobrosModal
      (cerrar)="cerrarModalCobros()">
  </app-cobros-modal>
</div>